## (d)通过**蒙特卡洛模拟**验证理论结果
- 生成大量随机样本
- 计算估计量 $T_n$
- 画出**方差、偏差、MSE**随样本量 $n$ 的变化图

#### 第一部分: 初始化设置
```r
set.seed(42)   #设置随机种子，确保结果可重复
	num_simulations <- 1000   #每个样本量n都重复模拟1000次,多次模拟更接近真实值(大数定律)
```

#### 第二部分: 定义估计量 $T_n$
题目给出: $T_n = \frac{2}{n} X_1^2 + \frac{n-2}{n(n-1)} \sum_{i=2}^n X_i^2$
```r
T_n <- function(sample) {
	n <- length(sample)   #样本大小
	term1 <- (2 / n) * sample[1]^2
	term2 <- (n - 2) / (n * (n - 1)) * sum(sample[-1]^2)
	return (term1 + term2)
}
```
* **sample[1]^2:** 第1个样本的平方
* **(2 / n) * sample[1]^2:** 公式第一项
* **sample[-1]:** 除第1个外的所有样本
* **sum(sample[-1]^2):** 第2到第n个样本的平方和
* **(n - 2) / (n * (n - 1)):** 公式第二项系数

#### 第三部分: 指标计算函数
```r
calculate_metrics <- function(n mu, sigma2) {
	#步骤1: 生成模拟数据
	T_n_values <- replicate(num_simulations, {
		sample <- rnorm(n, mean = mu, sd = sqrt(sigma2))
		T_n(sample)
	})
	
	true_variance <- sigma2
	
	#步骤2: 计算指标
	empirical_mean <- mean(T_n_values)
	empirical_variance <- var(T_n_values)
	bias <- empirical_mean - true_variance
	mse <- mean((T_n_values - true_variance)^2)
	
	#步骤3: 返回结果
	return (c(Variance = empirical_variance, Bias = bias, MSE = mse))
}
```
* **replicate(次数, {每次要执行的代码}):** 重复执行某段代码多次，返回一个向量
	* 例如: replicate(10, sample(1:6, 1)) ---> 可能输出: 3 1 6 2 4 5 4 6 1 2
	* 本题中: 
		* 重复1000次
		* 每次: 生成样本 --> 计算 T_n --> 记录结果
		* 最终得到1000个 T_n 值
* **rnorm(n, mean = 均值, sd = 标准差):** 生成 n 个服从正态分布的随机数
	* 为什么用 sqrt(sigma2)? ----题目给的是方差 σ² = 2，rnorm() 需要标准差，要开方
* **计算指标:**

| 计算   | 公式                                           | R函数    | 含义          |
| ---- | -------------------------------------------- | ------ | ----------- |
| 经验均值 | $\frac{1}{1000}\sum T_n^{(i)}$               | mean() | 1000次模拟的平均值 |
| 经验方差 | $\frac{1}{999}\sum(T_n^{(i)} - \bar{T}_n)^2$ | var()  | $T_n$ 的波动大小 |
| 偏差   | $\mathbb{E}(T_n) - \sigma^2$                 | 手动计算   | 估计值偏离真值多少   |
| MSE  | $\frac{1}{1000}\sum(T_n^{(i)} - \sigma^2)^2$ | mean() | 均方误差        |

#### 第四部分: 批量运行模拟
```r
n_values <- seq(10, 1000, 5)
results <- sapply(n_values, calculate_metrics, mu = 0, sigma2 = 2)
```
* **seq(from, to, by):** 生成等差数列
* **sapply(向量，函数，额外参数...):** 对每个向量的每个元素应用函数，简化结果*
* **本题相当于:**
```r
for (n in c(10, 15, 20, ..., 1000)) {
	calculate_metrics(n, mu = 0, sigma2 = 2)
}
```
* **results结构:** 是一个 3×199 的矩阵
```r
         [,1]   [,2]   [,3]  ...  [,199]
Variance 0.835  0.421  0.280 ...  0.020
Bias     0.012 -0.003  0.008 ...  0.001
MSE      0.846  0.423  0.288 ...  0.021

每一列对应一个 n 值
每一行对应一个指标
```

#### 第五部分: 绘制三张图
```r
par(mfrow = c(3, 1), mar = c(4, 4, 2, 1) + 0.1)   #设置图形参数

#Plot empirical variance
plot(n_values, 
	 results["Variance",],    #数据框提取 df[...,] 表示提取 ... 这一行的所有列
	 type = "l", 
	 col = "blue",
	 main = "Empirical Variance of T_n",
	 xlab = "n",
	 ylab = "Empirical Variance")

#Plot bias	 
plot(n_values, 
	 results["Bias",], 
	 type = "l", 
	 col = "red",
	 main = "Empirical Bias of T_n",
	 xlab = "n",
	 ylab = "Bias")
	 
#Plot MSE
plot(n_values, 
	 results["MSE",], 
	 type = "l", 
	 col = "green",
	 main = "MSE of T_n",
	 xlab = "n",
	 ylab = "MSE")
```
* **par(mfrow = c(行数, 列数), mar = c(下, 左, 上, 右))**
	* **mar 参数:** 设置图的边距 (z.B: mar = c(4, 4, 2, 1) 下和左留4行文字空间)
* **plot(x, y, type, col, main, xlab, ylab)**
	* **x:** 横坐标向量
	* **y:** 纵坐标向量
	* **type:** 图形类型
	* **col:** 颜色
	* **main:** 图标题
	* **xlab:** x轴标题
	* **ylab:** y轴标签



## (e)经验方差和理论方差对比

**之前计算得到:** $Var(T_n) = \frac{2\sigma^4}{n-1} = \frac{2(\sigma^2)^2}{n-1}$#### 理论公式实现
```r
theoretical_variance <- function(n, sigma2) {
  return(2 * sigma2^2 / (n-1))
}

#对每个n进行理论方差计算
theoretical_variances <- theoretical_variance(n_values, sigma2 = 2)
```

#### 对比图绘制
```r
plot(n_values, results["Variance", ], type = "l", col = "blue", 
     main = "Empirical vs. Theoretical Variance of T_n", 
     xlab = "n", ylab = "Variance",
     lwd = 2,
     ylim = range(c(results["Variance", ], theoretical_variances)))
lines(n_values, theoretical_variances, col = "red", lwd = 1)
legend("topright", legend = c("Empirical Variance", "Theoretical Variance"), 
       col = c("blue", "red"), lty = c(1, 2))
```
* **lwd参数:** 线宽
* **ylim参数:** 设置y轴范围
	* ylim = c(最小值, 最大值)
	* 本题中: ylim = range(c(经验方差, 理论方差)) 确保y轴能同时显示两条线
		* **range():** 取值范围函数
			* 例如: range(c(1, 5, 3, 9)) ---> c(1, 9)
* **lines():** 在现有图上添加新曲线
* **legend(位置, legend = 图例文字, col = 颜色, lty = 线型):** 添加图例
	* 位置参数: 
		* "topright" 右上角
		* "bottomright" 右下角
	* 线型:
		* lty = 1 实线
		* lty = 2 虚线
		* lty = 3 点线